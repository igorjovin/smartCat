<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<div>
    {% if tweets_with_predictions|length > 0 %}
      <div><button id="switch-tweets">Switch tweets</button></div>
      <table class="table table-striped table-bordered table-hover">
              {% for key, value in tweets_with_predictions.iteritems() %}
              <tr>
                  <td><b>{{indexes_with_tweets[key]}}</b></td> 
                  {% for val in value %}
                  <td>
                      {{val}} <button onclick="removeTag('{{key}}', '{{val}}')">Remove</button>
                  </td>
                  {% endfor %}
                  <td id="add_tag_{{key}}"><button onclick="addTag('{{key}}')">Add tag</button>  </td>
              </tr>
              {% endfor %}
      </table>
    {% else %}
      <p>No classifier with given name.</p>
    {% endif %}
</div>

<script type="text/javascript">

$("#switch-tweets").click(function() {
  $.ajax({
            url: '/classification/switch_tweet_view',
            contentType: 'application/json; charset=UTF-8',
            type: 'GET',
            dataType: "html",
            success: function(response) {
              $("#predictions").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
});

function addTag(tweet_index) {
  var cancel_elem = "<button onclick=\"cancelAddTag(" + tweet_index + ")\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmAddTag(" + tweet_index + ", '')\">OK</button>";
  var td_id = "#add_tag_" + tweet_index;
  $(td_id).empty();
  $(td_id).append(getSelect(tweet_index));
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function removeTag(tweet_index, tag) {
  var result = confirm("Are you sure you want to remove this tag from the tweet?");
  if (result) {
    $.ajax({
            url: '/classification/remove_tag',
            data: JSON.stringify({tweet_index: tweet_index, tag: tag}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#predictions").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
  };
}

function confirmAddTag(tweet_index, desired_tag) {
  var select_id = "#select_" + tweet_index;
  if (desired_tag == '') {
    desired_tag = $(select_id).find(":selected").text();
  } 
  if (desired_tag == "New group") {
      createNewGroup(tweet_index);
      return;
  }
  if (desired_tag == 'Created new') {
      desired_tag = $("#input-" + tweet_index).val();
  }
  $.ajax({
            url: '/classification/add_tag',
            data: JSON.stringify({desired_tag: desired_tag, tweet_index: tweet_index}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#predictions").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function cancelAddTag(tweet_index) {
  var td_id = "#add_tag_" + tweet_index;
  $(td_id).empty();
  $(td_id).append("<button onclick=\"addTag(" + tweet_index + ")\">Add tag</button>");
}

function createNewGroup(tweet_index) {
  var td_id = "#add_tag_" + tweet_index;
  var cancel_elem = "<button onclick=\"addTag(" + tweet_index + ")\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmAddTag(" + tweet_index + ", 'Created new')\">OK</button>";
  var group_name = "<input id=\"input-" + tweet_index + "\" type=\"text\" placeholder=\"New group\"/>";
  $(td_id).empty();
  $(td_id).append(group_name);
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function getSelect(tweet_index) {
  var select = "<select id=\"select_" + tweet_index + "\">";
  {% for value in classes %}
      select += "<option value='{{value}}'>{{value}}</option>";
  {% endfor %}
  select += "<option value='new_group'>New group</option>";
  select += "</select>";
  return select;
}

</script>
