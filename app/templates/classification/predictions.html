<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<div>
    <button id="new-group">Add new group</button>
    <table class="table table-striped table-bordered table-hover">
            {% for key, value in tweets.iteritems() %}
            <tr>
                <th id="group_{{key.replace(' ', '_')}}">{{key}}</th> 
            </tr>
              {% for val in value %}
                <tr>
                    <td>{{val}}</td> <td id="move_{{loop.index}}_{{key.replace(' ', '_')}}"><button onclick="move({{loop.index}}, '{{key}}')">Move</button>  <button onclick="remove({{loop.index}}, '{{key}}')">Remove</button></td>
                </tr>
              {% endfor %}
            {% endfor %}
    </table>
</div>

<script type="text/javascript">

function move(index, key) {
  var cancel_elem = "<button onclick=\"cancelMove(" + index + ", '" + key + "', '')\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmMove(" + index + ", '" + key + "', '')\">OK</button>";
  var new_key = key.replace(/\s/g, "_");
  new_key = new_key.replace(/\'/g, "");
  var td_id = "#move_" + index + "_" + new_key;
  $(td_id).empty();
  $(td_id).append(getSelect(index, "'" + key + "'"));
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function remove(index, key) {
  var result = confirm("Are you sure you want to remove this tweet from all classes?");
  if (result) {
    $.ajax({
            url: '/classification/remove_from_class',
            data: JSON.stringify({key: key, index: index}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#predictions").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
  };
}

function confirmMove(index, key, desired_key) {
  var new_key = key.replace(/\s/g, "_");
  new_key = new_key.replace(/\'/g, "");
  var select_id = "#select_" + index + "_" + new_key;
  if (desired_key == '') {
    desired_key = $(select_id).find(":selected").text();
  } 
  if (desired_key == "New group") {
      createNewGroup(index, key);
      return;
  }
  if (desired_key == 'Created new') {
      desired_key = $("#input-" + index).val();
  }
  $.ajax({
            url: '/classification/move_to_class',
            data: JSON.stringify({desired_key: desired_key, key: key, index: index}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#predictions").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function cancelMove(index, key) {
  var new_key = key.replace(/\s/g, "_");
  new_key = new_key.replace(/\'/g, "");
  var td_id = "#move_" + index + "_" + new_key;
  $(td_id).empty();
  $(td_id).append("<button onclick=\"move(" + index + ", '" + key + "')\">Move</button>");
  $(td_id).append("<button onclick=\"remove(" + index + ", '" + key + "')\">Remove</button>");
}

function createNewGroup(index, key) {
  var new_key = key.replace(/\s/g, "_");
  new_key = new_key.replace(/\'/g, "");
  var td_id = "#move_" + index + "_" + new_key;
  var cancel_elem = "<button onclick=\"move(" + index + ", '" + key + "')\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmMove(" + index + ", '" + key + "', 'Created new')\">OK</button>";
  var group_name = "<input id=\"input-" + index + "\" type=\"text\" placeholder=\"New group\"/>";
  $(td_id).empty();
  $(td_id).append(group_name);
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function getSelect(index, key) {
  var new_key = key.replace(/\s/g, "_");
  new_key = new_key.replace(/\'/g, "");
  var select = "<select id=\"select_" + index + "_" + new_key + "\">";
  {% for key_val, value in tweets.iteritems() %}
    if ('{{key_val}}' == key) {
      select += "<option value='{{key_val}}' selected>{{key_val}}</option>";
    } else {
      select += "<option value='{{key_val}}'>{{key_val}}</option>";
    }
  {% endfor %}
  select += "<option value='new_group'>New group</option>";
  select += "</select>";
  return select;
}

</script>
