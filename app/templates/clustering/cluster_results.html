<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<div>
    <table class="table table-striped table-bordered table-hover">
            {% for key, value in tweets.iteritems() %}
            <tr>
                <th id="group_{{key}}">{% if group_names[key] %} {{group_names[key]}} {% else %}Group {{key}}{% endif %}<button onclick="changeGroupName('{{key}}', '{{group_names[key]}}')">Change</button>  <button onclick="deleteGroup('{{key}}')">Delete</button>  <button onclick="mergeGroup('{{key}}')">Merge</button></th> 
            </tr>
              {% for val in value %}
                <tr>
                    <td>{{val}}</td> <td id="move_{{loop.index}}_{{key}}"><button onclick="move({{loop.index}}, '{{key}}')">Move</button>  <button onclick="remove({{loop.index}}, '{{key}}')">Remove</button></td>
                </tr>
              {% endfor %}
            {% endfor %}
    </table>
    <div id="training-buttons"><button onclick="chooseClassifier()">Train classifier >>></button></div>
</div>

<script type="text/javascript">

function chooseClassifier() {
  {% if group_names|length != tweets|length %}
    alert("Please rename all the groups");
    return;
  {% endif %}
  var ok_elem = "<button onclick=\"confirmClassifier()\">OK</button>";
  var cancel_elem = "<button onclick=\"cancelChooseClassifier()\">Cancel</button>";
  $("#training-buttons").empty();
  $("#training-buttons").append(getClassifierSelect());
  $("#training-buttons").append(ok_elem);
  $("#training-buttons").append(cancel_elem);
}

function move(index, key) {
  var td_id = "#move_" + index + "_" + key;
  var cancel_elem = "<button onclick=\"cancelMove(" + index + ", " + key + ")\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmMove(" + index + ", " + key + ")\">OK</button>";
  $(td_id).empty();
  $(td_id).append(getSelect(index, key));
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function remove(index, key) {
  var result = confirm("Are you sure you want to remove this tweet from all clusters?");
  if (result) {
    $.ajax({
            url: '/clustering/remove_from_cluster',
            data: JSON.stringify({key: key, index: index}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#cluster-results").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
  };
}

function deleteGroup(key) {
  var result = confirm("Are you sure you want to delete this cluster?");
  if (result) {
    $.ajax({
            url: '/clustering/delete_cluster',
            data: JSON.stringify({key: key}),
            contentType: 'application/json; charset=UTF-8',
            type: 'DELETE',
            dataType: "html",
            success: function(response) {
              $("#cluster-results").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
  };
}

function mergeGroup(key) {
  var td_id = "#group_" + key;
  var cancel_elem = "<button onclick=\"cancelMergeGroup(" + key + ")\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmMergeGroup(" + key + ")\">OK</button>";
  $(td_id).empty();
  $(td_id).append(getSelect("", key));
  $(td_id).append(ok_elem);
  $(td_id).append(cancel_elem);
}

function confirmMove(index, key) {
  var select_id = "#select_" + index + "_" + key;
  var desired_key = $(select_id).find(":selected").val();
  $.ajax({
            url: '/clustering/move_to_cluster',
            data: JSON.stringify({desired_key: desired_key, key: key, index: index}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#cluster-results").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function confirmMergeGroup(key) {
  var select_id = "#select_" + key;
  var desired_key = $(select_id).find(":selected").val();
  $.ajax({
            url: '/clustering/merge_cluster',
            data: JSON.stringify({desired_key: desired_key, key: key}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#cluster-results").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function confirmChangeGroupName(groupKey) {
  var desired_name = $("#group_input_" + groupKey).val();
  if (desired_name == "") {
      alert("Please enter a valid new name for group " + groupKey);
      return;
  }
  $.ajax({
            url: '/clustering/change_group_name',
            data: JSON.stringify({desired_name: desired_name, key: groupKey}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "html",
            success: function(response) {
              $("#cluster-results").html(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function confirmClassifier() {
	var select_id = "#select-classifiers";
  var classifier_name = $(select_id).find(":selected").text();
	$.ajax({
            url: '/classification/choose_classifier',
            data: JSON.stringify({classifier_name: classifier_name}),
            contentType: 'application/json; charset=UTF-8',
            type: 'POST',
            dataType: "json",
            success: function(response) {
  				    location.href = "/classification/train";
            },
            error: function(error) {
                console.log(error);
            }
        });
}

function cancelMove(index, key) {
  var td_id = "#move_" + index + "_" + key;
  $(td_id).empty();
  $(td_id).append("<button onclick='move(" + index + ", " + key + ")'>Move</button>");
  $(td_id).append("<button onclick='remove(" + index + ", " + key + ")'>Remove</button>");
}

function cancelMergeGroup(index, key) {
  var td_id = "#group_" + key;
  $(td_id).empty();
  $(td_id).append("<button onclick='changeGroupName(" + key + ")'>Change</button>");
  $(td_id).append("<button onclick='deleteGroup(" + key + ")'>Delete</button>");
  $(td_id).append("<button onclick='mergeGroup(" + key + ")'>Merge</button>");
}

function cancelChangeGroupName(groupKey, previousName) {
  var th_id = "#group_" + groupKey;
  var groupName = "Group " + groupKey;
  if (previousName) {
    groupName = previousName;
  }
  $(th_id).empty();
  $(th_id).append(groupName);
  $(th_id).append("<button onclick=\"changeGroupName(" + groupKey + ", '" + previousName + "')\">Change</button>");
  $(th_id).append("<button onclick=\"deleteGroup(" + groupKey + ")\">Delete</button>");
  $(th_id).append("<button onclick=\"mergeGroup(" + groupKey + ")\">Merge</button>");
}

function cancelChooseClassifier() {
  $("#training-buttons").empty();
  $("#training-buttons").append("<button onclick=\"chooseClassifier()\">Train classifier >>></button>");
}

function changeGroupName(groupKey, previousName) {
  var th_id = "#group_" + groupKey;
  var cancel_elem = "<button onclick=\"cancelChangeGroupName(" + groupKey + ", '" + previousName + "')\">Cancel</button>";
  var ok_elem = "<button onclick=\"confirmChangeGroupName(" + groupKey + ")\">OK</button>";
  var namePlaceholder = "Group " + groupKey;
  if (previousName) {
      namePlaceholder = previousName;
  }
  var input_elem = "<input id=\"group_input_" + groupKey + "\" type=\"text\" placeholder=\"" + namePlaceholder + "\"/>";
  $(th_id).empty();
  $(th_id).append(input_elem);
  $(th_id).append(ok_elem);
  $(th_id).append(cancel_elem);
}

function getSelect(index, key) {
  var select = "";
  if (index != "") {
    select = "<select id=\"select_" + index + "_" + key + "\">";
  } else {
    select = "<select id=\"select_" + key + "\">";
  }
  {% for key_val, value in tweets.iteritems() %}
    if ({{key_val}} == key) {
      select += "<option value=\"{{key_val}}\" selected>{% if group_names[key_val] %} {{group_names[key_val]}} {% else %}G {{key_val}}{% endif %}</option>";
    } else {
      select += "<option value=\"{{key_val}}\">{% if group_names[key_val] %} {{group_names[key_val]}} {% else %}G {{key_val}}{% endif %}</option>";
    }
  {% endfor %}
  select += "</select>";
  return select;
}

function getClassifierSelect() {
  var classifierSelect = "<select id=\"select-classifiers\">";
  classifierSelect += "<option value='XGBoost' >XGBoost</option>";
  classifierSelect += "<option value='SVC' >SVM (SVC)</option>";
  classifierSelect += "<option value='NaiveBayes'>Naive Bayes</option>";
  classifierSelect += "<option value='RandomForest'>Random Forest</option>";
  classifierSelect += "<option value='LinearRegression'>Linear Regression</option>";
  classifierSelect += "</select>";
  return classifierSelect;
}

</script>
